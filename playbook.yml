- name: Configure Application
  hosts: all
  become: true
  become_user: vagrant

  vars:
    repository_url: https://github.com/Moody-Tunes/moodytunes.git
    repository_path: /home/vagrant/moodytunes
    virtualenv_dir: "/home/vagrant/mtdj_env"
    virtualenv_source: "{{ virtualenv_dir }}/bin/activate"

  tasks:
    - name: Install packages
      become_user: root
      apt: 
        pkg:
          - git
          - nginx
          - python-pip
          - virtualenv
        update_cache: true
        state: present

    - name: Upgrade packages to latest version
      become_user: root
      apt:
        upgrade: yes

    - name: Clone repository
      git:
        repo: "{{ repository_url }}"
        dest: "{{ repository_path }}"

    - name: Create virtual environment
      command: virtualenv {{ virtualenv_dir }} --python=/usr/bin/python3

    - name: Install requirements
      pip:
        virtualenv: "{{ virtualenv_dir }}"
        requirements: "{{ repository_path }}/requirements/dev.txt"

    - name: Setup Django project
      shell: cd {{ repository_path }} && . {{ virtualenv_source }} && {{ item }}
      with_items:
        - python manage.py migrate
        - python manage.py loaddata apps/tunes/fixtures/Initial_Songs.json
      args:
        executable: /bin/bash
